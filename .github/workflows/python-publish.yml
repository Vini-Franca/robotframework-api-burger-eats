name: Robot Framework API Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Check out the repository
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    - name: Install dependencies for API
      run: |
        cd api
        npm install

    - name: Start API
      run: |
        cd api
        npm start &
      env:
        NODE_ENV: production

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Python dependencies
      run: |
        pip install robotframework
        pip install robotframework-requests
        pip install robotframework-yamllibrary
        pip install robot-mongodb-library

    - name: Run Robot Framework tests
      run: |
        robot --outputdir results tests/

    - name: Archive Robot Framework results
      uses: actions/upload-artifact@v3
      with:
        name: robot-results
        path: results/

    - name: Generate Robot Framework Summary
      run: |
        echo "### Robot Framework Results" >> $GITHUB_STEP_SUMMARY
        echo "| Result | Passed ✅ | Failed ❌ | Duration 🕗 |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-----------|-----------|-------------|" >> $GITHUB_STEP_SUMMARY
        PASSED=$(grep 'tests pass' results/report.html | awk '{print $1}')
        FAILED=$(grep 'tests fail' results/report.html | awk '{print $1}')
        DURATION=$(grep -o 'Elapsed time: [^<]*' results/report.html | awk '{print $3, $4}')
        echo "| Tests  | $PASSED    | $FAILED    | $DURATION |" >> $GITHUB_STEP_SUMMARY
